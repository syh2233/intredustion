# ESP32主机-从机系统部署指南

## 📋 系统架构

### 主机 (Master)
- **文件**: `main.py` (已更新支持从机)
- **功能**:
  - 原有的传感器监测 (火焰、烟雾、温度、湿度、光照、声音)
  - MQTT通信到云平台
  - UDP服务器接收从机数据
  - OLED显示和舵机控制
  - 从机状态监控

### 从机 (Slave)
- **文件**: `esp32_slave_simple.py`
- **功能**:
  - 火焰传感器监测
  - MQ2烟雾传感器监测
  - UDP通信发送数据到主机
  - LED状态指示
  - 自动重连机制

## 🔧 硬件连接

### 主机硬件连接 (保持原有配置)
- 火焰传感器: GPIO14
- MQ2烟雾传感器: GPIO34 (模拟), GPIO2 (数字)
- DHT11温湿度: GPIO4
- 声音传感器: GPIO13 (模拟), GPIO35 (数字)
- BH1750光照: GPIO21/22 (I2C)
- OLED显示: GPIO25/26 (I2C)
- 舵机控制: GPIO15

### 从机硬件连接
- **火焰传感器**: GPIO14 (模拟输入)
- **MQ2烟雾传感器**:
  - AO (模拟输出) → GPIO34
  - DO (数字输出) → GPIO2
  - VCC → 5V
  - GND → GND
- **LED指示灯**: GPIO5 (阳极→GPIO5, 阴极→GND, 串联220Ω电阻)
- **OLED显示屏**:
  - SDA (数据线) → GPIO26
  - SCL (时钟线) → GPIO25
  - VCC → 3.3V或5V
  - GND → GND

## ⚙️ 软件配置

### 1. 配置文件设置
编辑 `master_slave_config.py` 文件：

```python
# 修改WiFi配置
WIFI_SSID = "你的WiFi名称"
WIFI_PASSWORD = "你的WiFi密码"

# 修改从机配置 (如需要)
SLAVE1_ID = "esp32_slave_01"
SLAVE1_NAME = "从机-01"
SLAVE1_LOCATION = "宿舍A栋101"

# 修改传感器阈值 (如需要)
FLAME_ALARM_THRESHOLD = 500
MQ2_ALARM_THRESHOLD = 1000
```

### 2. 自动发现功能说明
系统现在支持从机自动发现主机IP地址，无需手动配置！

**工作原理**:
- 从机启动后通过UDP广播发送发现请求
- 主机收到请求后自动响应自己的IP地址
- 从机接收到响应后建立连接

**发现过程**:
1. 从机连接WiFi后自动开始主机发现
2. 发送3次发现请求，每次间隔2秒
3. 如果收到主机响应，显示发现成功并建立连接
4. 如果3次尝试都失败，从机程序退出

## 🚀 部署步骤

### 第一步：部署主机
1. **烧录主机程序**:
   - 将更新后的 `main.py` 烧录到主机ESP32
   - 确保所有传感器连接正确
   - 连接OLED显示屏和舵机

2. **启动主机**:
   - 上电启动主机ESP32
   - 观察串口输出，确认WiFi连接成功
   - 记录主机的IP地址
   - 确认UDP服务器启动成功：
     ```
     ✅ UDP服务器启动成功，等待从机连接...
     ```

### 第二步：部署从机
1. **硬件连接**:
   - 按照从机硬件连接图连接传感器
   - 确保LED指示灯连接正确
   - 为从机ESP32供电

2. **配置从机**:
   - 根据需要修改传感器阈值（无需配置主机IP）
   - 确保从机程序中的WiFi配置与主机相同

3. **烧录从机程序**:
   - 将 `esp32_slave_simple.py` 烧录到从机ESP32
   - 上电启动从机，观察自动发现过程

## 📊 监控和调试

### 主机监控
主机串口输出会显示：
- 主机传感器数据
- 从机连接状态：
  ```
  📱 新从机注册: esp32_slave_01 (192.168.1.101)
  ```
- 从机传感器数据：
  ```
  📨 从机数据 - esp32_slave_01 序列:1
     火焰:1200(normal) | 烟雾:1800(normal) | 整体:normal
  ```
- 从机警报：
  ```
  🚨 从机esp32_slave_01检测到火灾风险！
  ```
- 从机离线警告：
  ```
  ⚠️  有1个从机离线
  ```

### 从机监控
从机串口输出会显示：
- WiFi连接状态
- **主机发现过程**：
  ```
  🔍 开始自动发现主机...
  🔍 开始主机发现 (最多尝试3次)...

  --- 发现尝试 1/3 ---
  🔍 发送主机发现广播...
  📨 收到主机响应: 192.168.1.100
  ✅ 主机发现成功!
     主机IP: 192.168.1.100
     主机端口: 8888
     主机名称: 主机-01
  ✅ 主机发现成功: 192.168.1.100:8888
  ```
- 传感器读数
- 数据发送状态：
  ```
  [  1] 火焰:1200(normal) | 烟雾:1800(normal) | 整体:normal | ✅
  ```
- 错误信息和重连状态

### 状态指示 (从机)
#### LED指示灯
- **熄灭**: 正常状态
- **慢闪**: 警告状态
- **快闪**: 警报状态
- **常亮**: 系统错误

#### OLED显示屏
从机OLED显示主机和从机的完整传感器数据：
```
从机-01   IP:1.100
S:1200|1800
M:1500|2000
T:25C H:60%   #1
```

**显示说明**：
- **标题行**: 显示从机名称和主机IP后两位
- **从机数据**: S:火焰值|烟雾值
- **主机数据**: M:主机火焰值|主机烟雾值
- **环境数据**: T:温度°C H:湿度%
- **状态信息**: 数据发送序号

**数据同步**: 主机每30个循环（约60秒）向从机发送一次完整的主机传感器数据，包括温度、湿度、火焰和烟雾传感器读数。

## 🔍 故障排除

### 网络连接问题
```
问题: 从机无法发现主机
解决:
1. 确认主机和从机在同一WiFi网络
2. 确认主机UDP服务器正在运行 (查看主机串口输出)
3. 确认主机已连接WiFi并获取IP地址
4. 检查手机热点是否允许UDP广播通信
5. 重启主机和从机设备

问题: 主机发现超时
解决:
1. 确保主机先启动，从机后启动
2. 检查网络延迟和稳定性
3. 减少网络设备数量，避免网络拥堵
4. 尝试将设备靠近路由器
```

### 数据传输问题
```
问题: 主机收不到从机数据
解决:
1. 检查从机配置的HOST_IP是否正确
2. 确认UDP端口8888未被占用
3. 检查网络防火墙设置
4. 重启主机和从机设备
```

### 传感器读数异常
```
问题: 传感器读数异常
解决:
1. 检查传感器接线
2. 确认传感器供电正常
3. MQ2传感器需要预热24-48小时
4. 检查电压分压器(如使用5V供电)
```

### 从机离线问题
```
问题: 主机显示从机离线
解决:
1. 检查从机WiFi连接
2. 确认从机程序正在运行
3. 检查从机供电
4. 重启从机设备
```

## 📈 扩展部署

### 添加更多从机
1. 复制 `esp32_slave_simple.py` 为新的从机文件
2. 修改从机ID和名称：
   ```python
   SLAVE_ID = "esp32_slave_03"
   SLAVE_NAME = "从机-03"
   ```
3. 烧录到新的ESP32设备
4. 部署到不同位置

### 网络优化
- 将设备放置在WiFi信号良好的位置
- 使用信号增强器扩大覆盖范围
- 避免过多设备连接同一路由器

### 电源管理
- 使用稳定的5V电源
- 添加电容滤波
- 考虑使用UPS备用电源

## 🔒 安全注意事项

1. **电气安全**: 确保所有接线正确，避免短路
2. **防火安全**: MQ2传感器工作时可能发热，保持通风
3. **网络安全**: 使用强WiFi密码，定期更新
4. **数据安全**: 定期备份配置文件

## 📞 技术支持

如遇到问题，请检查：
1. 串口输出的错误信息
2. WiFi连接状态
3. 主机和从机IP地址
4. 传感器连接和供电
5. 本指南的故障排除部分

## 📝 维护记录

建议记录：
- 设备部署位置和日期
- 传感器校准日期
- 故障处理记录
- 软件更新记录
- 从机增减记录