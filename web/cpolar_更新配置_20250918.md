# Cpolar内网穿透配置更新 (2025年09月18日)

## 🆕 更新内容

电脑重启后，Cpolar隧道地址已更新，请及时更新您的ESP32配置。

## 📋 新的隧道地址

### Web监控界面
- **HTTPS (推荐)**: https://75eff755.r40.cpolar.top
- **HTTP**: http://75eff755.r40.cpolar.top
- **本地服务**: http://localhost:5000

### MQTT通信
- **MQTT Broker**: tcp://22.tcp.cpolar.top:14871
- **本地服务**: tcp://127.0.0.1:1883
- **更新时间**: 2025年09月18日 15时12分07秒

### MQTT WebSocket
- **WebSocket**: tcp://22.tcp.cpolar.top:11281
- **本地服务**: tcp://127.0.0.1:8083
- **更新时间**: 2025年09月18日 15时12分06秒

### 其他服务
- **人脸识别(HTTP)**: http://548f49b5.r40.cpolar.top
- **人脸识别(HTTPS)**: https://548f49b5.r40.cpolar.top
- **本地服务**: http://localhost:7860

## 🔧 ESP32配置更新

### MQTT配置更新
```python
# 更新前 (旧配置)
MQTT_SERVER = "22.tcp.cpolar.top"
MQTT_PORT = 10067

# 更新后 (新配置)
MQTT_SERVER = "22.tcp.cpolar.top"
MQTT_PORT = 14871  # 🆕 端口已更新
```

### Web地址更新
```python
# 更新前 (旧地址)
WEB_URL = "https://3b89539d.r40.cpolar.top"

# 更新后 (新地址)
WEB_URL_HTTPS = "https://75eff755.r40.cpolar.top"  # 🆕 新地址
WEB_URL_HTTP = "http://75eff755.r40.cpolar.top"    # 🆕 HTTP地址
```

## 📝 更新步骤

### 1. 更新ESP32代码
```python
# 修改 esp32_dht22_sensor.py 中的配置
MQTT_SERVER = "22.tcp.cpolar.top"
MQTT_PORT = 14871  # 🔄 更新为新的端口
```

### 2. 更新Web前端
如果您的Web前端有硬编码的WebSocket地址，也需要更新：
```javascript
// 更新为新的地址
const socket = io('https://75eff755.r40.cpolar.top', {
    secure: true,
    transports: ['websocket']
});
```

### 3. 测试连接
```bash
# 测试Web界面
curl https://75eff755.r40.cpolar.top/api/data/recent?limit=5

# 测试MQTT连接
mosquitto_sub -h 22.tcp.cpolar.top -p 14871 -t "esp32/+/data/json" -v
```

## ⚠️ 重要提醒

1. **Cpolar免费版特性**:
   - 每次重启可能变化地址
   - 需要及时更新配置
   - 建议保存当前配置

2. **备用访问方式**:
   - 如果Cpolar不稳定，可直接使用本地地址
   - 本地Web: http://localhost:5000
   - 本地MQTT: tcp://127.0.0.1:1883

3. **生产环境建议**:
   - 考虑升级Cpolar付费版获得固定地址
   - 或者使用其他稳定的内网穿透方案

## 🚀 快速验证

### 1. 验证Web界面
打开浏览器访问: https://75eff755.r40.cpolar.top

### 2. 验证API接口
```bash
curl https://75eff755.r40.cpolar.top/api/data/recent?limit=1
```

### 3. 验证MQTT连接
```python
# Python测试代码
import paho.mqtt.client as mqtt

def on_connect(client, userdata, flags, rc):
    print(f"连接结果: {rc}")

client = mqtt.Client()
client.on_connect = on_connect
client.connect("22.tcp.cpolar.top", 14871, 60)
print("MQTT连接测试完成")
```

## 📞 故障排除

### 如果连接失败
1. 确认Cpolar客户端正在运行
2. 检查端口是否正确 (14871)
3. 验证网络连接正常
4. 查看Cpolar状态页面

### 如果Web界面无法访问
1. 确认本地Flask服务运行在5000端口
2. 检查Cpolar隧道状态
3. 尝试使用HTTP地址: http://75eff755.r40.cpolar.top

---

**更新完成！请及时更新您的配置以使用新的隧道地址。** 🎉