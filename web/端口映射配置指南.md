# 路由器端口映射配置指南
# =========================

## 概述
为了让ESP32设备能够从外网访问你的私有云平台，需要在路由器上配置端口映射。

## 需要映射的端口

### 协议说明
- **TCP协议**: 所有服务都使用TCP协议
  - HTTP/HTTPS基于TCP
  - MQTT协议基于TCP
  - WebSocket基于TCP

### 端口映射表

| 服务 | 内部端口 | 外部端口 | 协议 | 说明 |
|------|----------|----------|------|------|
| Flask Web界面 | 5000 | 5000 | TCP | Web监控界面访问 (HTTP/HTTPS) |
| MQTT Broker | 1883 | 1883 | TCP | ESP32设备MQTT连接 |
| MQTT WebSocket | 8083 | 8083 | TCP | Web界面实时通信 |

### 端口使用详情
- **5000/TCP**: Flask Web服务器，处理HTTP请求和WebSocket连接
- **1883/TCP**: MQTT Broker，处理ESP32设备连接和消息传输
- **8083/TCP**: MQTT over WebSocket，支持浏览器直接连接MQTT

## 配置步骤

### 1. 登录路由器管理界面
- 打开浏览器，访问路由器IP地址（通常是 192.168.1.1 或 192.168.0.1）
- 输入管理员用户名和密码

### 2. 找到端口映射功能
不同品牌路由器的位置可能不同：
- **TP-Link**: 转发规则 -> 虚拟服务器
- **华为路由器**: 高级 -> NAT -> 端口映射
- **小米路由器**: 高级设置 -> 端口转发
- **ASUS路由器**: 外部网络 -> 端口转发

### 3. 添加端口映射规则

#### 规则1: Web界面
- **服务名称**: Flask_Web
- **内部IP地址**: [你的电脑IP地址，如 192.168.1.100]
- **内部端口**: 5000
- **外部端口**: 5000
- **协议**: TCP
- **状态**: 启用

#### 规则2: MQTT服务
- **服务名称**: MQTT_Broker
- **内部IP地址**: [你的电脑IP地址]
- **内部端口**: 1883
- **外部端口**: 1883
- **协议**: TCP
- **状态**: 启用

#### 规则3: MQTT WebSocket
- **服务名称**: MQTT_WebSocket
- **内部IP地址**: [你的电脑IP地址]
- **内部端口**: 8083
- **外部端口**: 8083
- **协议**: TCP
- **状态**: 启用

### 4. 获取外网访问地址

#### 如果有公网IP
```
Web界面: http://[你的公网IP]:5000
MQTT: [你的公网IP]:1883
```

#### 如果使用DDNS（动态域名）
```
Web界面: http://[你的域名]:5000
MQTT: [你的域名]:1883
```

### 5. 防火墙配置

#### Windows防火墙设置
1. 打开"Windows Defender 防火墙"
2. 点击"高级设置"
3. 选择"入站规则"
4. 点击"新建规则"

#### 添加端口规则
- **规则类型**: 端口
- **协议**: TCP
- **特定端口**: 5000, 1883, 8083
- **操作**: 允许连接
- **配置文件**: 域、专用、公用
- **名称**: ESP32_Fire_Alarm_System

### 6. 测试外部访问

#### 测试Web界面
```
http://[你的外网IP]:5000
```

#### 测试MQTT连接
```python
# 使用Python测试MQTT连接
import paho.mqtt.client as mqtt

def on_connect(client, userdata, flags, rc):
    print(f"连接结果: {rc}")

client = mqtt.Client()
client.on_connect = on_connect
client.connect("[你的外网IP]", 1883, 60)
client.loop_start()
```

## 安全建议

### 1. 使用强密码
- 修改MQTT默认密码
- 使用复杂的用户名和密码组合

### 2. 限制访问IP
- 在路由器中设置IP白名单
- 只允许特定的IP地址访问

### 3. 启用SSL/TLS
- 为Web界面配置HTTPS
- 为MQTT配置SSL（MQTTS）

### 4. 定期更新
- 保持系统和软件更新
- 定期检查日志文件

## 故障排除

### 1. 端口无法访问
- 检查端口映射配置是否正确
- 确认防火墙设置
- 验证服务是否正在运行

### 2. 连接超时
- 检查网络连接
- 确认IP地址是否正确
- 检查路由器日志

### 3. 权限问题
- 确认防火墙规则
- 检查用户权限设置
- 验证服务配置

## 注意事项

1. **静态IP地址**: 建议为服务器设置静态IP地址
2. **带宽考虑**: 确保网络带宽足够支持设备连接
3. **备份配置**: 定期备份路由器配置
4. **监控日志**: 定期检查访问日志和安全日志